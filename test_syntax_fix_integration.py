#!/usr/bin/env python3
"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ PlantUML
"""

import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ sys.path –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from plantuml_generator import render_plantuml
from plantuml_syntax_fixer import auto_fix_plantuml, validate_plantuml_syntax

def test_syntax_fix():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    
    # –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ —Å –æ—à–∏–±–∫–∞–º–∏ –æ—Ç GigaChat
    broken_code = """@startuml
!thme plain
title –û–Ω–ª–∞–π–Ω-–∑–∞–∫–∞–∑ –µ–¥—ã –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ

:start
:–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ;
:–ü—Ä–æ—Å–º–æ—Ç—Ä –º–µ–Ω—é;
if (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –±–ª—é–¥–æ?) then (–î–∞)
  :–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–ª—é–¥–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É;
else (–ù–µ—Ç)
  :–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ–∞–Ω—Å–∞;
endif
:if (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?) then (–î–∞)
  :–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞;
  :–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞;
  :–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞;
  :–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ–∞–Ω—Å–∞;
else (–ù–µ—Ç)
  :–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–µ–Ω—é;
endif
:stop
@enduml"""
    
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ PlantUML")
    print("=" * 60)
    
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞
    print("1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ –Ω–∞ –æ—à–∏–±–∫–∏:")
    is_valid, errors = validate_plantuml_syntax(broken_code)
    print(f"   –í–∞–ª–∏–¥–µ–Ω: {is_valid}")
    if errors:
        print("   –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏:")
        for error in errors:
            print(f"   ‚Ä¢ {error}")
    
    # 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    print("\n2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:")
    fixed_code, fixes_applied = auto_fix_plantuml(broken_code)
    
    if fixes_applied:
        print("   –ü—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:")
        for fix in fixes_applied:
            print(f"   ‚Ä¢ {fix}")
    else:
        print("   –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è")
    
    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
    print("\n3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞:")
    is_valid_fixed, errors_fixed = validate_plantuml_syntax(fixed_code)
    print(f"   –í–∞–ª–∏–¥–µ–Ω: {is_valid_fixed}")
    if errors_fixed:
        print("   –û—Å—Ç–∞—é—â–∏–µ—Å—è –æ—à–∏–±–∫–∏:")
        for error in errors_fixed:
            print(f"   ‚Ä¢ {error}")
    
    # 4. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
    print("\n4. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–æ–¥–æ–≤:")
    print("\nüìÑ –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥:")
    print(broken_code)
    print("\n‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥:")
    print(fixed_code)
    
    # 5. –¢–µ—Å—Ç —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ (–±–µ–∑ UI)
    print("\n5. –¢–µ—Å—Ç —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞):")
    try:
        # –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –∫–æ–¥ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
        if is_valid_fixed:
            print("   ‚úÖ –ö–æ–¥ –≥–æ—Ç–æ–≤ –∫ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É")
        else:
            print("   ‚ùå –ö–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—à–∏–±–∫–∏")
    except Exception as e:
        print(f"   ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ: {e}")
    
    return is_valid_fixed

def test_edge_cases():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤"""
    
    print("\n" + "=" * 60)
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤")
    print("=" * 60)
    
    test_cases = [
        # –ü—É—Å—Ç–æ–π –∫–æ–¥
        ("", "–ü—É—Å—Ç–æ–π –∫–æ–¥"),
        
        # –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∫–æ–¥
        ("@startuml\n!theme plain\nstart\n:–î–µ–π—Å—Ç–≤–∏–µ;\nstop\n@enduml", "–ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∫–æ–¥"),
        
        # –¢–æ–ª—å–∫–æ !thme –æ—à–∏–±–∫–∞
        ("@startuml\n!thme plain\n@enduml", "–¢–æ–ª—å–∫–æ !thme –æ—à–∏–±–∫–∞"),
        
        # –¢–æ–ª—å–∫–æ –¥–≤–æ–µ—Ç–æ—á–∏—è
        ("@startuml\n:start\n:if (—É—Å–ª–æ–≤–∏–µ?) then\n:else\n:endif\n:stop\n@enduml", "–¢–æ–ª—å–∫–æ –¥–≤–æ–µ—Ç–æ—á–∏—è"),
        
        # –°–ª–æ–∂–Ω—ã–π —Å–ª—É—á–∞–π —Å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ if
        ("""@startuml
!thme plain
:start
:if (A?) then (–î–∞)
  :if (B?) then (–î–∞)
    :–î–µ–π—Å—Ç–≤–∏–µ 1;
  :else (–ù–µ—Ç)
    :–î–µ–π—Å—Ç–≤–∏–µ 2;
  :endif
:else (–ù–µ—Ç)
  :–î–µ–π—Å—Ç–≤–∏–µ 3;
:endif
:stop
@enduml""", "–í–ª–æ–∂–µ–Ω–Ω—ã–µ if —Å –¥–≤–æ–µ—Ç–æ—á–∏—è–º–∏")
    ]
    
    for code, description in test_cases:
        print(f"\nüìã –¢–µ—Å—Ç: {description}")
        print("-" * 40)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        is_valid_before, errors_before = validate_plantuml_syntax(code)
        print(f"   –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è: {is_valid_before}")
        if errors_before:
            print(f"   –û—à–∏–±–∫–∏: {errors_before[:2]}...")  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 2 –æ—à–∏–±–∫–∏
        
        # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        fixed_code, fixes = auto_fix_plantuml(code)
        print(f"   –ü—Ä–∏–º–µ–Ω–µ–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π: {len(fixes)}")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        is_valid_after, errors_after = validate_plantuml_syntax(fixed_code)
        print(f"   –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è: {is_valid_after}")
        
        if not is_valid_after and errors_after:
            print(f"   –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏: {errors_after}")

if __name__ == "__main__":
    print("üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ PlantUML")
    
    # –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ—Å—Ç
    main_test_passed = test_syntax_fix()
    
    # –¢–µ—Å—Ç –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
    test_edge_cases()
    
    print("\n" + "=" * 60)
    print("üìä –ò—Ç–æ–≥–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:")
    print(f"‚Ä¢ –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ—Å—Ç: {'‚úÖ –ü—Ä–æ–π–¥–µ–Ω' if main_test_passed else '‚ùå –ù–µ –ø—Ä–æ–π–¥–µ–Ω'}")
    print("‚Ä¢ –ì—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏: –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã")
    print("‚Ä¢ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å plantuml_generator: ‚úÖ –ì–æ—Ç–æ–≤–∞")
    print("\nüéâ –°–∏—Å—Ç–µ–º–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ PlantUML –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!")
