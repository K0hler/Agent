#!/usr/bin/env python3
"""
–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ PlantUML
"""

import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ sys.path –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from plantuml_syntax_fixer import auto_fix_plantuml, validate_plantuml_syntax

def demo_real_world_scenario():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"""
    
    print("üé¨ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è: –†–µ–∞–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π —Å GigaChat")
    print("=" * 60)
    
    # –°–∏–º—É–ª–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –æ—Ç GigaChat —Å –æ—à–∏–±–∫–∞–º–∏
    gigachat_response = """@startuml
!thme plain
title –û–Ω–ª–∞–π–Ω-–∑–∞–∫–∞–∑ –µ–¥—ã –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ

:start
:–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ;
:–ü—Ä–æ—Å–º–æ—Ç—Ä –º–µ–Ω—é;
if (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –±–ª—é–¥–æ?) then (–î–∞)
  :–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–ª—é–¥–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É;
else (–ù–µ—Ç)
  :–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ–∞–Ω—Å–∞;
endif
:if (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?) then (–î–∞)
  :–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞;
  :–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞;
  :–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞;
  :–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ–∞–Ω—Å–∞;
else (–ù–µ—Ç)
  :–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–µ–Ω—é;
endif
:stop
@enduml"""
    
    print("üì• –û—Ç–≤–µ—Ç –æ—Ç GigaChat (—Å –æ—à–∏–±–∫–∞–º–∏):")
    print(gigachat_response)
    print()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    print("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:")
    is_valid_before, errors_before = validate_plantuml_syntax(gigachat_response)
    print(f"   –°—Ç–∞—Ç—É—Å: {'‚úÖ –í–∞–ª–∏–¥–Ω—ã–π' if is_valid_before else '‚ùå –û—à–∏–±–∫–∏ –Ω–∞–π–¥–µ–Ω—ã'}")
    
    if errors_before:
        print("   –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏:")
        for i, error in enumerate(errors_before, 1):
            print(f"   {i}. {error}")
        print()
    
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    print("üîß –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...")
    fixed_code, fixes_applied = auto_fix_plantuml(gigachat_response)
    
    print(f"   ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ {len(fixes_applied)} –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:")
    for fix in fixes_applied:
        print(f"   ‚Ä¢ {fix}")
    print()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    print("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:")
    is_valid_after, errors_after = validate_plantuml_syntax(fixed_code)
    print(f"   –°—Ç–∞—Ç—É—Å: {'‚úÖ –í–∞–ª–∏–¥–Ω—ã–π' if is_valid_after else '‚ùå –û—Å—Ç–∞—é—Ç—Å—è –æ—à–∏–±–∫–∏'}")
    
    if errors_after:
        print("   –û—Å—Ç–∞—é—â–∏–µ—Å—è –æ—à–∏–±–∫–∏:")
        for error in errors_after:
            print(f"   ‚Ä¢ {error}")
    else:
        print("   üéâ –í—Å–µ –æ—à–∏–±–∫–∏ —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã!")
    
    print()
    print("üìÑ –ò—Ç–æ–≥–æ–≤—ã–π –∫–æ–¥ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞:")
    print(fixed_code)
    
    return is_valid_after

def demo_user_experience():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞"""
    
    print("\n" + "=" * 60)
    print("üë§ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç")
    print("=" * 60)
    
    print("üìù –°—Ü–µ–Ω–∞—Ä–∏–π:")
    print("1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –æ–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã")
    print("2. GigaChat –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥–∏–∞–≥—Ä–∞–º–º—É —Å –æ—à–∏–±–∫–∞–º–∏")
    print("3. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –æ—à–∏–±–∫–∏")
    print("4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –¥–∏–∞–≥—Ä–∞–º–º—É")
    print()
    
    # –ü—Ä–∏–º–µ—Ä "—Å—ã—Ä–æ–≥–æ" –æ—Ç–≤–µ—Ç–∞ –æ—Ç GigaChat
    raw_response = """{
    "title": "–°–∏—Å—Ç–µ–º–∞ –æ–Ω–ª–∞–π–Ω-–∑–∞–∫–∞–∑–∞ –µ–¥—ã",
    "bpmn_plantuml": "@startuml\n!thme plain\ntitle BPMN Process Diagram\n\n:start\n:–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ;\n:–ü—Ä–æ—Å–º–æ—Ç—Ä –º–µ–Ω—é;\nif (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –±–ª—é–¥–æ?) then (–î–∞)\n  :–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–ª—é–¥–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É;\nelse (–ù–µ—Ç)\n  :–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ–∞–Ω—Å–∞;\nendif\n:if (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?) then (–î–∞)\n  :–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞;\n  :–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞;\n  :–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞;\n  :–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ–∞–Ω—Å–∞;\nelse (–ù–µ—Ç)\n  :–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–µ–Ω—é;\nendif\n:stop\n@enduml",
    "usecase_plantuml": "@startuml\n!thme plain\ntitle Use Case Diagram\n\nactor \"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å\" as user\nactor \"–†–µ—Å—Ç–æ—Ä–∞–Ω\" as restaurant\n\nusecase \"–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–µ–Ω—é\" as uc1\nusecase \"–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É\" as uc2\nusecase \"–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑\" as uc3\nusecase \"–û–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑\" as uc4\n\nuser --> uc1\nuser --> uc2\nuser --> uc3\nuser --> uc4\n\nrestaurant --> uc3\n@enduml",
    "requirements_md": "### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è\\n\\n1. **FR-001**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –º–µ–Ω—é\\n2. **FR-002**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –±–ª—é–¥–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É"
}"""
    
    print("üì¶ –°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç –æ—Ç GigaChat (JSON):")
    print(raw_response)
    print()
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º PlantUML –∫–æ–¥ (—Å–∏–º—É–ª—è—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON)
    import json
    try:
        data = json.loads(raw_response)
        bpmn_code = data["bpmn_plantuml"]
        usecase_code = data["usecase_plantuml"]
        
        print("üîç –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π PlantUML –∫–æ–¥ (BPMN):")
        print(bpmn_code[:100] + "..." if len(bpmn_code) > 100 else bpmn_code)
        print()
        
        print("üîç –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π PlantUML –∫–æ–¥ (Use-Case):")
        print(usecase_code[:100] + "..." if len(usecase_code) > 100 else usecase_code)
        print()
        
        # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ–±–∞ –∫–æ–¥–∞
        print("üîß –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–æ–∏—Ö –∫–æ–¥–æ–≤...")
        
        fixed_bpmn, bpmn_fixes = auto_fix_plantuml(bpmn_code)
        fixed_usecase, usecase_fixes = auto_fix_plantuml(usecase_code)
        
        print(f"   BPMN –¥–∏–∞–≥—Ä–∞–º–º–∞: {len(bpmn_fixes)} –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π")
        print(f"   Use-Case –¥–∏–∞–≥—Ä–∞–º–º–∞: {len(usecase_fixes)} –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π")
        
        if bpmn_fixes:
            print("   –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è BPMN:")
            for fix in bpmn_fixes:
                print(f"   ‚Ä¢ {fix}")
        
        if usecase_fixes:
            print("   –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è Use-Case:")
            for fix in usecase_fixes:
                print(f"   ‚Ä¢ {fix}")
        
        print()
        print("‚úÖ –ì–æ—Ç–æ–≤–æ! –û–±–µ –¥–∏–∞–≥—Ä–∞–º–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É.")
        
        return True
        
    except json.JSONDecodeError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}")
        return False

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏"""
    
    print("üéâ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ PlantUML")
    print("–†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—à–∏–±–∫–∞–º–∏ –æ—Ç GigaChat API")
    print("=" * 70)
    
    # –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
    scenario_success = demo_real_world_scenario()
    
    # –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞
    ux_success = demo_user_experience()
    
    print("\n" + "=" * 70)
    print("üìä –ò—Ç–æ–≥–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏:")
    print(f"‚Ä¢ –†–µ–∞–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: {'‚úÖ –£—Å–ø–µ—à–µ–Ω' if scenario_success else '‚ùå –ù–µ—É–¥–∞—á–µ–Ω'}")
    print(f"‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç: {'‚úÖ –£—Å–ø–µ—à–µ–Ω' if ux_success else '‚ùå –ù–µ—É–¥–∞—á–µ–Ω'}")
    print()
    print("üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å–∏—Å—Ç–µ–º—ã:")
    print("  ‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫")
    print("  ‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö —Ç–∏–ø–æ–≤ –¥–∏–∞–≥—Ä–∞–º–º (BPMN –∏ Use-Case)")
    print("  ‚Ä¢ –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)")
    print("  ‚Ä¢ –ì–∏–±–∫–æ—Å—Ç—å (—Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º–∏ –æ—à–∏–±–∫–∞–º–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞)")
    print("  ‚Ä¢ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π")
    print()
    print("üöÄ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!")

if __name__ == "__main__":
    main()
